#!/usr/bin/env node

let chalk = require('chalk');
let ora = require('ora');
let request = require('request');
let program = require('commander');

let log = require('../src/log');

/**
 * Padding
 */
log.tips();

let spinner = ora({
    text: "fetching templates list...",
    color:"blue"
}).start();

process.on('exit', function () {
    log.tips();
});

/**
 * Help.
 */

program.on('--help', function () {
    log.tips('  Examples:');
    log.tips();
    log.tips(chalk.gray('    # list all available official templates from github.com/waka-templates'));
    log.tips('    $ waka list');
    log.tips();
});

if(process.argv[2]){
    program.help();
}

/**
 * List repos.
 */

request({
    url: 'https://api.github.com/users/waka-templates/repos',
    headers: {
        'User-Agent': 'waka-cli'
    },
    auth:{
        'user': 'dwqs',
        'pass': 'bf109fcd625bdb3ee127e0f3f97063d527823881'
    }
}, (err, res, body) => {
    if(err){
        spinner.text = chalk.red('waka cli:fetching templates list failed.');
        spinner.fail();
        process.exit(1);
    }

    let requestBody = JSON.parse(body);
    if (Array.isArray(requestBody)) {
        spinner.text = chalk.green('Available official templates:');
        spinner.succeed();

        log.tips();
        requestBody.forEach(function (repo) {
            log.tips(
                '  ' + chalk.yellow('*') +
                '  ' + chalk.blue(repo.name) +
                ' - ' + repo.description);
        });
    } else {
        spinner.text = chalk.white('waka cli:fetching templates list failed,error message as follows:');
        spinner.fail();

        log.tips();
        log.error(requestBody.message);
    }
});
